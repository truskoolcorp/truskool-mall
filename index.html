<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtual Tru Skool Mall</title>
  <meta name="description" content="Virtual Tru Skool Mall — Three.js starter" />
  <style>
    :root { --bg:#0a0a0a; --panel:#0f0f0f; --border:#2a2a2a; --text:#eaeaea; --dim:#bdbdbd; --chip:#0f0f12; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden}

    #three{position:fixed;inset:0;width:100vw;height:100vh;display:block}

    .topbar{position:fixed;left:10px;right:10px;top:10px;z-index:30;display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      background:rgba(15,15,15,.9);border:1px solid var(--border);border-radius:12px;padding:8px 10px;box-shadow:0 8px 28px rgba(0,0,0,.45)}
    .brand{font-weight:800;padding:6px 10px;background:#0d0d0d;border:1px solid var(--border);border-radius:10px;white-space:nowrap}
    #mallGrid{display:flex;gap:8px;align-items:center;overflow-x:auto;scrollbar-width:thin;padding:2px 0;flex:1 1 auto}
    .tile{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;background:var(--chip);border:1px solid var(--border);
      border-radius:10px;cursor:pointer;user-select:none;white-space:nowrap;transition:transform .12s,border-color .12s,background .12s}
    .tile:hover{transform:translateY(-1px);border-color:#3b3b3b;background:#121217}
    .tile img{width:16px;height:16px;object-fit:contain;border-radius:3px}

    .tip{position:fixed;right:16px;top:56px;z-index:20;background:rgba(15,15,15,.85);border:1px solid var(--border);
      border-radius:10px;padding:5px 10px;color:var(--dim);font-size:12px}

    .foot{position:fixed;left:0;right:0;bottom:6px;text-align:center;z-index:5;color:#8a8a8a;font-size:11px;text-shadow:0 1px 2px rgba(0,0,0,.6);pointer-events:none}

    #loader{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.6);z-index:50;transition:opacity .3s}
    #loader .box{display:grid;gap:12px;place-items:center}
    #loader .spinner{width:48px;height:48px;border-radius:50%;border:4px solid rgba(255,255,255,.2);border-top-color:#fff;animation:spin 1s linear infinite}
    #loader .msg{color:#fff;font:600 14px/1.2 system-ui,sans-serif;opacity:.9}
    @keyframes spin{to{transform:rotate(360deg)}}

    .help-btn{position:fixed;right:14px;top:14px;z-index:40;width:36px;height:36px;border-radius:10px;border:1px solid var(--border);
      background:var(--panel);color:#fff;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,.35)}
    .help-panel{position:fixed;right:14px;top:58px;z-index:40;width:320px;max-width:calc(100% - 28px);background:rgba(15,15,15,.96);
      color:#eee;border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 12px 40px rgba(0,0,0,.45)}
    .help-panel h3{margin:0 0 8px;font:700 16px system-ui,sans-serif}
    .help-panel p,.help-panel li{font:400 13px/1.45 system-ui,sans-serif;color:#cfcfcf}
    .help-panel .close{position:absolute;right:8px;top:6px;background:transparent;border:0;color:#aaa;font-size:20px;cursor:pointer}

    @media (max-width:640px){.brand{display:none}.tip{display:none}}
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader" aria-live="polite">
    <div class="box">
      <div class="spinner" aria-hidden="true"></div>
      <div class="msg">Loading…</div>
    </div>
  </div>

  <!-- Help -->
  <button id="helpBtn" class="help-btn" aria-label="Help">?</button>
  <div id="helpPanel" class="help-panel" hidden>
    <button id="helpClose" class="close" aria-label="Close">×</button>
    <h3>Virtual Tru Skool Mall</h3>
    <ul>
      <li>Drag to look around; scroll or pinch to zoom.</li>
      <li>Click a brand tile or glowing portal to open its link.</li>
      <li>Press <b>H</b> or <b>?</b> to toggle this help.</li>
    </ul>
    <p>Manage brands in <code>src/stores.json</code> and logos in <code>assets/images/</code>.</p>
  </div>

  <!-- Top bar -->
  <div class="topbar" role="navigation" aria-label="Brand shortcuts">
    <div class="brand">Virtual Tru Skool Mall</div>
    <div id="mallGrid" aria-label="Stores"></div>
  </div>

  <div class="tip">Tip: Click a brand tile or 3D portal to open its link.</div>

  <!-- Canvas -->
  <canvas id="three"></canvas>

  <div class="foot">Starter template • three.js • Ready for Vercel/Netlify • Enhance with 3D avatars later</div>

  <noscript style="position:fixed;inset:0;display:grid;place-items:center;background:#000;color:#fff;z-index:100;">
    This site needs JavaScript enabled.
  </noscript>

  <!-- All app code inlined -->
  <script type="module">
    // Help panel wiring
    const helpBtn = document.getElementById('helpBtn');
    const helpPanel = document.getElementById('helpPanel');
    const helpClose = document.getElementById('helpClose');
    const toggleHelp = (force) => {
      if (!helpPanel) return;
      if (typeof force === 'boolean') { helpPanel.hidden = !force; return; }
      helpPanel.hidden = !helpPanel.hidden;
    };
    helpBtn?.addEventListener('click', () => toggleHelp());
    helpClose?.addEventListener('click', () => toggleHelp(false));
    window.addEventListener('keydown', (e)=>{ if(e.key==='h'||e.key==='?') toggleHelp(); });

    // Safe loader fallback (never leave user stuck)
    const loaderEl = document.getElementById('loader');
    const loaderMsg = loaderEl?.querySelector('.msg');
    setTimeout(() => { if(loaderEl){ loaderEl.style.opacity='0'; setTimeout(()=>loaderEl.style.display='none',300);} }, 8000);

    // Import libs
    import * as THREE from 'https://unpkg.com/three@0.159.0/build/three.module.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.159.0/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader }   from 'https://unpkg.com/three@0.159.0/examples/jsm/loaders/GLTFLoader.js';

    // Loading manager
    const manager = new THREE.LoadingManager(
      () => { if(loaderEl){ loaderEl.style.opacity='0'; setTimeout(()=>loaderEl.style.display='none',300);} },
      (url, loaded, total) => { if(loaderMsg) loaderMsg.textContent = `Loading ${loaded}/${total}…`; },
      (url) => { console.warn('Failed to load:', url); }
    );

    // Fetch stores
    manager.itemStart('stores.json');
    const STORES = await fetch('./src/stores.json')
      .then(r => r.ok ? r.json() : [])
      .catch(() => [])
      .finally(() => manager.itemEnd('stores.json'));
    if (!Array.isArray(STORES) || STORES.length === 0) console.warn('No stores in src/stores.json');

    // Renderer / Scene / Camera
    const canvas = document.getElementById('three');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
    camera.position.set(0, 2.25, 6.2);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; controls.dampingFactor = 0.06;
    controls.enablePan = false;
    controls.minDistance = 3.4; controls.maxDistance = 7.6;
    controls.minPolarAngle = Math.PI * 0.18; controls.maxPolarAngle = Math.PI * 0.48;

    // Lights / Floor
    scene.add(new THREE.HemisphereLight(0xffffff, 0x222244, 1.0));
    const dir = new THREE.DirectionalLight(0xffffff, 1.0); dir.position.set(2,5,3); scene.add(dir);
    const floor = new THREE.Mesh(
      new THREE.CircleGeometry(6.2, 64),
      new THREE.MeshStandardMaterial({ color:0x111111, metalness:0.2, roughness:0.9 })
    );
    floor.rotation.x = -Math.PI/2; floor.receiveShadow = true; scene.add(floor);

    // Try to load GLB portal arch
    let archTemplate = null;
    try {
      const glb = await new GLTFLoader(manager).loadAsync('./assets/models/portal.glb');
      archTemplate = glb.scene || glb.scenes?.[0] || null;
      if (archTemplate) {
        const box = new THREE.Box3().setFromObject(archTemplate);
        const size = box.getSize(new THREE.Vector3()).length() || 1;
        archTemplate.scale.setScalar(2.2 / size);
      }
    } catch (e) {
      console.warn('portal.glb not found, using procedural arch');
    }

    // Procedural arch fallback
    function makeProceduralArch(){
      const g = new THREE.Group();
      const mat = new THREE.MeshStandardMaterial({ color:0x2b2b2b, metalness:0.2, roughness:0.6 });
      const legGeo = new THREE.CylinderGeometry(0.08,0.08,2.0,20);
      const left = new THREE.Mesh(legGeo, mat);  left.position.set(-0.9,1.0,0); g.add(left);
      const right= new THREE.Mesh(legGeo, mat); right.position.set( 0.9,1.0,0); g.add(right);
      const top  = new THREE.Mesh(new THREE.BoxGeometry(2.0,0.16,0.2), mat); top.position.set(0,2.08,0); g.add(top);
      return g;
    }

    // Glow sprite
    function makeGlowSprite(){
      const size=512, c=document.createElement('canvas'); c.width=c.height=size;
      const ctx=c.getContext('2d');
      const grad=ctx.createRadialGradient(size/2,size/2,size*0.05,size/2,size/2,size*0.45);
      grad.addColorStop(0.0,'rgba(90,107,255,0.35)');
      grad.addColorStop(0.5,'rgba(90,107,255,0.18)');
      grad.addColorStop(1.0,'rgba(90,107,255,0.0)');
      ctx.fillStyle=grad; ctx.fillRect(0,0,size,size);
      const tex=new THREE.CanvasTexture(c); tex.colorSpace=THREE.SRGBColorSpace;
      const sp=new THREE.Sprite(new THREE.SpriteMaterial({map:tex,transparent:true,depthWrite:false,blending:THREE.AdditiveBlending,opacity:0.85}));
      sp.scale.set(2.6,2.6,1); sp.userData.baseScale=2.6; return sp;
    }

    // Label
    function makeLabel(text){
      const c=document.createElement('canvas'); c.width=512; c.height=128;
      const ctx=c.getContext('2d'); ctx.fillStyle='rgba(0,0,0,0.55)'; ctx.fillRect(0,0,c.width,c.height);
      ctx.fillStyle='#fff'; ctx.font='bold 48px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
      ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(text,c.width/2,c.height/2);
      const tex=new THREE.CanvasTexture(c); tex.colorSpace=THREE.SRGBColorSpace;
      const sp=new THREE.Sprite(new THREE.SpriteMaterial({map:tex,depthTest:false,depthWrite:false,transparent:true,opacity:0.95}));
      sp.scale.set(1.7,0.42,1); return sp;
    }

    // Cards / portals
    const group = new THREE.Group(); scene.add(group);
    const texLoader = new THREE.TextureLoader(manager);
    const raycaster = new THREE.Raycaster(); const mouse = new THREE.Vector2();
    let clickable=[]; const glows=[];
    const hoverMat = new THREE.MeshStandardMaterial({ emissive:0x5a6bff, emissiveIntensity:0.35, metalness:0.1, roughness:0.6 });

    function createFlatCard(store, pos, lookAt){
      const tex=texLoader.load(store.logo); tex.colorSpace=THREE.SRGBColorSpace;
      const mat=new THREE.MeshStandardMaterial({ map:tex, metalness:0.1, roughness:0.6 });
      const mesh=new THREE.Mesh(new THREE.PlaneGeometry(1.6,1.6), mat);
      mesh.position.copy(pos); mesh.lookAt(lookAt);
      mesh.userData={ link:store.link, name:store.name, baseMat:mat };
      group.add(mesh); clickable.push(mesh);

      const stand=new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.08,1.0,14),
                                 new THREE.MeshStandardMaterial({ color:0x2a2a2a }));
      stand.position.set(pos.x,0.5,pos.z); scene.add(stand);

      const label=makeLabel(store.name); label.position.copy(pos).add(new THREE.Vector3(0,0.95,0)); scene.add(label);
      mesh.userData.label=label;

      mesh.onBeforeRender=()=>{ mesh.position.y=1.45 + Math.sin(performance.now()/700 + pos.x + pos.z)*0.05;
                                label.position.y=mesh.position.y + 0.95; };
      return mesh;
    }

    function createPortal(store, index, total){
      const angle = (index/total)*Math.PI*2;
      const radius = 3.9;
      const pos = new THREE.Vector3(Math.cos(angle)*radius,1.45,Math.sin(angle)*radius);
      const centerLook = new THREE.Vector3(0,1.25,0);

      const card = createFlatCard(store, pos, centerLook);

      const arch = archTemplate ? archTemplate.clone(true) : makeProceduralArch();
      arch.traverse(n=>{ if(n.isMesh){ n.castShadow=n.receiveShadow=true; } });
      arch.position.set(pos.x,0,pos.z); arch.lookAt(0,1.2,0);
      const back = new THREE.Vector3().subVectors(arch.position, centerLook).setLength(0.25);
      arch.position.add(back); scene.add(arch);

      const glow = makeGlowSprit
