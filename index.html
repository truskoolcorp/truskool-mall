<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Virtual Tru Skool Mall</title>
  <meta name="description" content="Virtual Tru Skool Mall – three.js starter" />

  <!-- Import map: lets vendor loaders that say `from "three"` work in browser -->
  <script type="importmap">
  { "imports": { "three": "/vendor/three/three.module.js" } }
  </script>

  <style>
    :root{
      --bg:#0b0c10; --panel:#13141a; --chip:#181a22; --chip-b:#2b2f3a;
      --text:#e9ecf1; --muted:#9ca3af;
      --brand1:#213a8f; --brand2:#bb3a45; --brand3:#56a06a;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;overflow:hidden}
    .topbar{position:fixed;left:12px;right:12px;top:12px;z-index:20;display:flex;align-items:center;gap:10px;padding:8px 10px;background:rgba(19,20,26,.55);border:1px solid var(--chip-b);border-radius:12px;backdrop-filter:blur(6px)}
    .brand{font-weight:800;letter-spacing:.3px;margin-right:6px;opacity:.95}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);cursor:pointer;user-select:none}
    .dot{width:8px;height:8px;border-radius:50%}
    .chip[data-id="faithfully-faded"] .dot{background:var(--brand1)}
    .chip[data-id="concrete-rose"]   .dot{background:var(--brand2)}
    .chip[data-id="cafe-sativa"]     .dot{background:var(--brand3)}
    .tip{position:fixed;top:12px;right:12px;z-index:19;padding:6px 10px;font-size:12px;color:var(--muted);background:rgba(19,20,26,.55);border:1px solid var(--chip-b);border-radius:10px;backdrop-filter:blur(6px)}
    canvas#three{position:fixed;inset:0;display:block;width:100%;height:100%}
    .loader{position:fixed;inset:0;display:grid;place-items:center;z-index:30;background:radial-gradient(ellipse at center, rgba(0,0,0,.25), rgba(0,0,0,.85) 60%)}
    .loader.hide{opacity:0;visibility:hidden;transition:opacity .25s ease .05s, visibility 0s linear .3s}
    .spinner{width:50px;height:50px;border:3px solid rgba(255,255,255,.22);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;margin:8px auto}
    .msg{color:#e9ecf1;font-weight:600;letter-spacing:.2px;text-align:center;white-space:pre-line}
    @keyframes spin{to{transform:rotate(360deg)}}
    .foot{position:fixed;left:0;right:0;bottom:8px;text-align:center;color:#818896;font-size:11px;opacity:.85}
    @media (max-width:640px){.brand{display:none}.tip{display:none}}
  </style>
</head>
<body>
  <div class="topbar"><div class="brand">Virtual Tru Skool Mall</div><div id="chipRow" class="chips"></div></div>
  <div class="tip">Tip: click a top chip or a 3D sign to open its link.</div>
  <canvas id="three"></canvas>

  <div id="loader" class="loader" aria-live="polite">
    <div>
      <div class="spinner"></div>
      <div id="loadMsg" class="msg">Loading…</div>
    </div>
  </div>

  <div class="foot">Starter • three.js • Netlify-ready • Add avatars later</div>

  <script type="module">
    const $ = s => document.querySelector(s);
    const loadMsg = $('#loadMsg'); const loader = $('#loader');

    // 1) Preflight: verify the three files exist before importing
    async function preflight() {
      const files = [
        '/vendor/three/three.module.js',
        '/vendor/three/OrbitControls.js',
        '/vendor/three/GLTFLoader.js'
      ];
      for (const f of files) {
        const r = await fetch(f, { cache: 'no-cache' });
        if (!r.ok) throw new Error(`Missing file: ${f} (${r.status})`);
      }
    }

    // 2) Tiny helper for store list
    const colorFor = id => id==='faithfully-faded'?0x213a8f:id==='concrete-rose'?0xbb3a45:id==='cafe-sativa'?0x56a06a:0x3a3f4a;
    async function loadStores(){
      try {
        const r = await fetch('/src/stores.json', { cache: 'no-cache' });
        if (!r.ok) throw 0;
        return r.json();
      } catch {
        // Fallback defaults
        return [
          {"id":"faithfully-faded","name":"Faithfully Faded","logo":"/assets/images/faithfully-faded.png","link":"https://www.faithfully-faded.com"},
          {"id":"concrete-rose","name":"Concrete Rose","logo":"/assets/images/concrete-rose.png","link":"https://concrete-rose.world"},
          {"id":"cafe-sativa","name":"Café Sativa","logo":"/assets/images/cafe-sativa.png","link":"https://cafe-sativa-llc-uzn6.b12sites.com/"}
        ];
      }
    }
    function buildChips(stores){
      const row = $('#chipRow'); row.innerHTML='';
      for (const s of stores) {
        const chip = document.createElement('div');
        chip.className = 'chip'; chip.dataset.id = s.id;
        chip.innerHTML = `<span class="dot"></span>${s.name}`;
        chip.onclick = () => window.open(s.link, '_blank');
        row.appendChild(chip);
      }
    }

    // 3) Start
    (async () => {
      try {
        loadMsg.textContent = 'Checking local 3D libraries…';
        await preflight();

        loadMsg.textContent = 'Starting 3D…';
        // After preflight, we can import safely
        const THREE = await import('three');
        const { OrbitControls } = await import('/vendor/three/OrbitControls.js');
        const { GLTFLoader }  = await import('/vendor/three/GLTFLoader.js');

        // Basic renderer/scene (with a TEST CUBE so you see something immediately)
        const canvas = document.getElementById('three');
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setPixelRatio(Math.min(devicePixelRatio,2));
        renderer.setSize(innerWidth, innerHeight);
        renderer.outputEncoding = THREE.sRGBEncoding;
        renderer.setClearColor(0x0b0c10, 1);

        const scene = new THREE.Scene();
        scene.fog = new THREE.Fog(0x0b0c10, 12, 28);
        const camera = new THREE.PerspectiveCamera(50, innerWidth/innerHeight, 0.1, 100);
        camera.position.set(0, 1.7, 7);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.target.set(0,1.3,0);
        controls.minDistance = 4; controls.maxDistance = 15;

        scene.add(new THREE.HemisphereLight(0x93a4ff, 0x0b0c10, 0.6));
        const dir = new THREE.DirectionalLight(0xffffff, 1.0); dir.position.set(3,5,2); scene.add(dir);

        const ground = new THREE.Mesh(new THREE.CircleGeometry(20,64), new THREE.MeshStandardMaterial({color:0x0e1016, roughness:.95}));
        ground.rotation.x = -Math.PI/2; scene.add(ground);

        // TEST CUBE — if you see a spinning cube, 3D is alive
        const testCube = new THREE.Mesh(new THREE.BoxGeometry(0.6,0.6,0.6), new THREE.MeshStandardMaterial({ color: 0x6aa0ff, metalness:.2, roughness:.4 }));
        testCube.position.set(0,1.4,0); scene.add(testCube);

        // Signs
        const clickable = [];
        function makeLabelTexture(text, bg='#151a22'){
          const c = document.createElement('canvas'); c.width=512; c.height=512;
          const g = c.getContext('2d'); g.fillStyle=bg; g.fillRect(0,0,512,512);
          g.fillStyle='#e9ecf1'; g.font='bold 64px system-ui,Segoe UI,Arial';
          g.textAlign='center'; g.textBaseline='middle'; g.fillText(text,256,256);
          const t = new THREE.CanvasTexture(c); t.anisotropy=8; t.encoding=THREE.sRGBEncoding; return t;
        }
        function addSign(store,i,n){
          const board = new THREE.Mesh(new THREE.PlaneGeometry(1.1,1.4), new THREE.MeshStandardMaterial({ map: makeLabelTexture(store.name,'#151822'), color: colorFor(store.id) }));
          board.userData.link = store.link;
          const post = new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,0.9,12), new THREE.MeshStandardMaterial({ color:0x2f323b, roughness:.8 }));
          post.position.y = -1.15;
          const g = new THREE.Group(); g.add(board,post);
          const r=5, a=(i-(n-1)/2)*(Math.PI/7); g.position.set(Math.sin(a)*r,1.3,Math.cos(a)*r); g.lookAt(0,1.3,0);
          scene.add(g); clickable.push(board);
        }

        const stores = await loadStores(); buildChips(stores);
        stores.forEach((s,i)=>addSign(s,i,stores.length));

        // Optional portal
        try {
          const { scene: portal } = await new Promise((res,rej)=> new GLTFLoader().load('/assets/models/portal.glb', g=>res(g), undefined, rej));
          portal.position.set(-2.3,0,1.4); portal.rotation.y=Math.PI*0.25; scene.add(portal);
        } catch(e) { /* ok for now */ }

        // Picking
        const ray = new THREE.Raycaster(), mouse = new THREE.Vector2();
        renderer.domElement.addEventListener('click', (e)=>{
          const r = renderer.domElement.getBoundingClientRect();
          mouse.x=((e.clientX-r.left)/r.width)*2-1; mouse.y=-((e.clientY-r.top)/r.height)*2+1;
          ray.setFromCamera(mouse,camera);
          const hits = ray.intersectObjects(clickable,true);
          if (hits.length) { const u = hits[0].object.userData.link; if (u) window.open(u,'_blank'); }
        });

        // Animate
        loader.classList.add('hide');
        function loop(){ testCube.rotation.y += 0.01; controls.update(); renderer.render(scene,camera); requestAnimationFrame(loop) }
        loop();

        addEventListener('resize', ()=>{ camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); });
      } catch (err) {
        console.error(err);
        loadMsg.textContent = (err && err.message) ? String(err.message) : 'Error starting app (see console)';
      }
    })();
  </script>
</body>
</html>
