<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Virtual Tru Skool Mall</title>
<meta name="description" content="Virtual Tru Skool Mall – three.js showroom" />
<style>
  :root{
    --bg:#0c0c0f; --panel:#141418; --text:#e8e8ef; --muted:#9aa0a6;
    --chip:#1c1d23; --chip-border:#2a2c33; --accent:#6aa0ff;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .topbar{position:fixed;inset:12px 12px auto 12px;display:flex;gap:10px;align-items:center;z-index:20;
    background:rgba(20,20,26,.6);border:1px solid var(--chip-border);border-radius:12px;padding:8px 10px;backdrop-filter:blur(6px)}
  .brand{font-weight:800;letter-spacing:.3px;margin-right:6px;opacity:.9}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--chip-border);
    background:var(--chip);color:var(--text);cursor:pointer;user-select:none}
  .chip .dot{width:8px;height:8px;border-radius:50%;opacity:.9}
  .tip{position:fixed;top:12px;right:12px;z-index:19;color:var(--muted);font-size:12px;opacity:.9;background:rgba(20,20,26,.6);
    border:1px solid var(--chip-border);border-radius:10px;padding:6px 10px;backdrop-filter:blur(6px)}
  canvas#three{position:fixed;inset:0;display:block;width:100%;height:100%}
  .loader{position:fixed;inset:0;display:grid;place-items:center;z-index:40;background:radial-gradient(ellipse at center,rgba(0,0,0,.2),rgba(0,0,0,.85) 60%);
    transition:opacity .25s ease .05s,visibility 0s linear .3s}
  .loader.hide{opacity:0;visibility:hidden}
  .spinner{width:52px;height:52px;border:3px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;
    animation:spin 1.1s linear infinite;margin:8px auto}
  .load-msg{text-align:center;font-weight:600}
  @keyframes spin{to{transform:rotate(360deg)}}
  .foot{position:fixed;left:0;right:0;bottom:8px;text-align:center;color:#7c808a;font-size:11px;opacity:.8;pointer-events:none}
  @media(max-width:640px){.brand{display:none}.tip{display:none}}
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Virtual Tru Skool Mall</div>
    <div id="chipRow" style="display:flex;gap:8px;flex-wrap:wrap"></div>
  </div>
  <div class="tip">Tip: click a brand chip or a 3D sign to open its link.</div>
  <canvas id="three"></canvas>
  <div class="loader" id="loader"><div><div class="spinner"></div><div class="load-msg" id="loaderMsg">Loading…</div></div></div>
  <div class="foot">Tru Skool • three.js • Netlify‑ready • Add avatars later</div>

<script type="module">
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const loader = $('#loader');
const loaderMsg = $('#loaderMsg');
function showErr(msg){ loader.classList.remove('hide'); loaderMsg.textContent = msg; }

// ------- fetch stores
let STORES = [];
try{
  const res = await fetch('/src/stores.json', {cache:'no-store'});
  if(!res.ok) throw new Error('stores.json not found');
  STORES = await res.json();
}catch(e){
  console.error(e);
  showErr('Error loading brands config'); throw e;
}

// ------- create chips
const chipRow = $('#chipRow');
for(const s of STORES){
  const el = document.createElement('div');
  el.className = 'chip'; el.dataset.id = s.id;
  el.innerHTML = `<span class="dot" style="background:${s.color||'#6aa0ff'}"></span>${s.name}`;
  el.onclick = () => window.open(s.link, '_blank');
  chipRow.appendChild(el);
}

// ------- load three from CDN with fallback
async function loadThree(){
  const bases = ['https://unpkg.com','https://cdn.jsdelivr.net/npm'];
  let last;
  for(const base of bases){
    try{
      const THREE = await import(`${base}/three@0.159.0/build/three.module.js`);
      const OrbitControls = await import(`${base}/three@0.159.0/examples/jsm/controls/OrbitControls.js`);
      const GLTFLoader = await import(`${base}/three@0.159.0/examples/jsm/loaders/GLTFLoader.js`);
      return {THREE, OrbitControls, GLTFLoader};
    }catch(e){ console.warn('CDN failed', base, e); last = e; }
  }
  throw last ?? new Error('CDNs blocked');
}

let THREE, OrbitControls, GLTFLoader;
try{
  ({THREE, OrbitControls, GLTFLoader} = await loadThree());
}catch(e){
  console.error(e);
  showErr('Error loading 3D libs. Disable ad/script blockers or refresh.'); throw e;
}

// ------- 3D scene
try {
  const canvas = $('#three');
  const renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:false});
  renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
  renderer.setSize(innerWidth, innerHeight);
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.0;

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0c0c0f);

  const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 200);
  camera.position.set(0, 3.4, 9);

  const controls = new OrbitControls.OrbitControls(camera, renderer.domElement);
  controls.target.set(0,1.2,0);
  controls.enableDamping = true;
  controls.minDistance = 5; controls.maxDistance = 18;
  controls.maxPolarAngle = Math.PI*0.495;

  // Ground
  const g = new THREE.Group(); scene.add(g);
  const ground = new THREE.Mesh(
    new THREE.CylinderGeometry(20,20,0.2,64,1,true),
    new THREE.MeshStandardMaterial({color:0x141418, roughness:0.9, metalness:0.0})
  );
  ground.receiveShadow = true; ground.position.y = -0.1; g.add(ground);

  // Lights (bright studio)
  const hemi = new THREE.HemisphereLight(0xffffff, 0x222233, 0.9); scene.add(hemi);
  const key = new THREE.DirectionalLight(0xffffff, 1.2);
  key.position.set(6,10,6); key.castShadow = true; key.shadow.mapSize.set(1024,1024);
  scene.add(key);
  const fill = new THREE.DirectionalLight(0xffffff, 0.6); fill.position.set(-6,6,-6); scene.add(fill);
  const rim = new THREE.DirectionalLight(0xffffff, 0.4); rim.position.set(0,7,-10); scene.add(rim);
  const ringLight = new THREE.SpotLight(0x88aaff, 0.5, 30, Math.PI/3, 0.25, 1.5);
  ringLight.position.set(0,6,0); ringLight.target = ground; ringLight.castShadow = true; scene.add(ringLight);

  // Center "portal" frame (simple)
  const frame = new THREE.Group();
  const mat = new THREE.MeshStandardMaterial({color:0x5560aa, metalness:.2, roughness:.3});
  const post = new THREE.Mesh(new THREE.BoxGeometry(0.25,2.6,0.25), mat); post.position.set(-1,1.3,0); post.castShadow=true; post.receiveShadow=true; frame.add(post);
  const post2 = post.clone(); post2.position.x = 1; frame.add(post2);
  const top = new THREE.Mesh(new THREE.BoxGeometry(2.3,0.25,0.25), mat); top.position.set(0,2.65,0); top.castShadow=true; top.receiveShadow=true; frame.add(top);
  scene.add(frame);

  // Brand signs
  const ringR = 8, signW=1.1, signH=1.4;
  const texLoader = new THREE.TextureLoader();
  const clickable = [];
  const toRad = ang => ang * Math.PI/180;

  STORES.forEach((s, i) => {
    const angle = i * (360 / STORES.length);
    const rad = toRad(angle);
    const x = Math.cos(rad) * ringR;
    const z = Math.sin(rad) * ringR;
    // Sign
    const group = new THREE.Group(); group.position.set(x, 0, z); group.lookAt(0,1.2,0);
    const plane = new THREE.Mesh(
      new THREE.PlaneGeometry(signW, signH, 1, 1),
      new THREE.MeshStandardMaterial({color:0x1a1e2a, metalness:.1, roughness:.6})
    );
    plane.position.y = 1.25; plane.castShadow = true; plane.receiveShadow = true;
    // texture
    const tex = texLoader.load(s.logo, () => { renderer.render(scene,camera); });
    tex.colorSpace = THREE.SRGBColorSpace;
    const img = new THREE.Mesh(new THREE.PlaneGeometry(signW*0.92, signH*0.92),
      new THREE.MeshBasicMaterial({map:tex, transparent:true}));
    img.position.set(0, 0, 0.01);
    plane.add(img);
    group.add(plane);
    // Stand
    const stand = new THREE.Mesh(new THREE.CylinderGeometry(0.06,0.06,0.9,16), new THREE.MeshStandardMaterial({color:0x2b2f3a,metalness:.2,roughness:.6}));
    stand.position.set(0,0.45,0.2); stand.castShadow = true; group.add(stand);
    scene.add(group);
    clickable.push({mesh:plane, link:s.link});
  });

  // Click handler
  const raycaster = new THREE.Raycaster();
  const pointer = new THREE.Vector2();
  function onPointer(e){
    const rect = renderer.domElement.getBoundingClientRect();
    pointer.x = ((e.clientX - rect.left)/rect.width)*2 - 1;
    pointer.y = -((e.clientY - rect.top)/rect.height)*2 + 1;
    raycaster.setFromCamera(pointer, camera);
    const intersects = raycaster.intersectObjects(clickable.map(o=>o.mesh), true);
    if(intersects.length){
      const hit = intersects[0].object;
      const item = clickable.find(o => o.mesh===hit || hit.parent===o.mesh || hit===o.mesh.children?.[0]);
      if(item) window.open(item.link, '_blank');
    }
  }
  renderer.domElement.addEventListener('click', onPointer);

  // Loop
  function onResize(){ camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); }
  addEventListener('resize', onResize);

  function tick(t){
    controls.update();
    renderer.render(scene, camera);
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
  loader.classList.add('hide');
}catch(e){
  console.error(e);
  showErr('Error starting app (check console)');
}
</script>
</body>
</html>
